name: Workflow Status

on:
  workflow_run:
    workflows: ["Validate", "Test", "Build", "Deploy", "BibCheck", "Lint"]
    types: [completed]

jobs:
  status:
    name: Update Status
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'

    steps:
      - name: 📥 Check out repository
        uses: actions/checkout@v4

      - name: 📋 Report workflow failure
        uses: actions/github-script@v7
        with:
          script: |
            const workflow = context.payload.workflow_run;
            console.log(`❌ Workflow "${workflow.name}" failed`);
            console.log(`🔗 URL: ${workflow.html_url}`);
            console.log(`📝 Conclusion: ${workflow.conclusion}`);

            // Create issue for persistent failures if needed
            if (workflow.run_attempt > 2) {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Workflow "${workflow.name}" failing repeatedly`,
                body: `The workflow "${workflow.name}" has failed ${workflow.run_attempt} times.

                **Details:**
                - Run ID: ${workflow.id}
                - URL: ${workflow.html_url}
                - Conclusion: ${workflow.conclusion}
                - Head SHA: ${workflow.head_sha}

                Please investigate and fix the underlying issue.`,
                labels: ['bug', 'workflow', 'needs-investigation']
              });
            }
