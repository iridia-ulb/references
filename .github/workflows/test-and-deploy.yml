name: CI (Legacy)

on:
  pull_request:
    paths-ignore: ['README.md','bibpool/**','**precommit','setup_worktree.sh','mklog','**.latexmkrc','.gitignore']

env:
  cache-version: v2

jobs:
  # Quick validation for PRs
  validate-pr:
    name: PR Validation
    if: "! contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Check out repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ” Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            bibcheck: [ 'crossref.bib', 'biblio.bib', './scripts/bibcheck.R' ]
            bibfiles: [ '**.bib' ]

      - name: âš¡ Quick syntax check
        if: steps.filter.outputs.bibfiles == 'true'
        run: |
          echo "Running quick syntax validation..."
          ./test/fast_check.sh *.bib

      # R-based validation
      - name: ğŸ”§ Setup R
        if: steps.filter.outputs.bibcheck == 'true'
        uses: r-lib/actions/setup-r@v2

      - name: ğŸ“¦ Install R dependencies
        if: steps.filter.outputs.bibcheck == 'true'
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: cran::rbibutils
          dependencies: '"hard"'

      - name: âœ… Run bibliography checks
        if: steps.filter.outputs.bibcheck == 'true'
        run: Rscript ./scripts/bibcheck.R

  # Full testing for significant changes
  full-test:
    name: Full Testing Suite
    needs: validate-pr
    if: github.event.pull_request.changed_files > 5
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“‹ Cache TinyTeX
        id: cache-tinytex
        uses: actions/cache@v4
        with:
          path: ~/.TinyTeX
          key: ${{ env.cache-version }}-${{ runner.os }}-tinytex-${{ hashFiles('.github/texlive_packages') }}
          restore-keys: |
            ${{ env.cache-version }}-${{ runner.os }}-tinytex-

      - name: ğŸ”§ Setup TinyTeX
        if: steps.cache-tinytex.outputs.cache-hit != 'true'
        uses: r-lib/actions/setup-tinytex@v2
        env:
          TINYTEX_INSTALLER: TinyTeX-1
          TINYTEX_VERSION: 2023.12

      - name: ğŸ“¦ Install LaTeX packages
        if: steps.cache-tinytex.outputs.cache-hit != 'true'
        run: |
          texlive_packages=./.github/texlive_packages
          tlmgr option repository https://ftp.math.utah.edu/pub/tex/historic/systems/texlive/2023/tlnet-final
          tlmgr option -- autobackup 0
          tlmgr update --self
          tlmgr install $(sed 's/\s*#.*//;/^\s*$/d' "${texlive_packages}")
          tlmgr path add

      - name: ğŸ§ª Run comprehensive tests
        run: cd test && ./test.sh

      - name: ğŸ“¦ Install system packages
        run: |
          sudo apt -y update
          sudo apt -y install bibtex2html tidy ghostscript qpdf

      - name: ğŸ—œï¸ Test PDF compression
        run: cd test && ./compress.sh testbib.pdf testshortbib.pdf && mv --force -t ../web/ testbib.pdf testshortbib.pdf

      - name: ğŸŒ Test HTML generation
        run: ./scripts/optbib2html.sh


